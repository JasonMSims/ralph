#!/bin/bash
# Ralph - Autonomous task execution orchestrator for Claude
# https://github.com/JasonMSims/ralph

set -e

RALPH_BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
RALPH_LIB_DIR="${RALPH_BIN_DIR}/lib"

# Parse global flags before sourcing config
# This allows flags to override environment variables
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --mode=*)
            export RALPH_MODE="${1#*=}"
            shift
            ;;
        --mode)
            export RALPH_MODE="$2"
            shift 2
            ;;
        --permission-mode=*)
            export RALPH_PERMISSION_MODE="${1#*=}"
            shift
            ;;
        --permission-mode)
            export RALPH_PERMISSION_MODE="$2"
            shift 2
            ;;
        --task-file=*)
            export RALPH_TASK_FILE="${1#*=}"
            shift
            ;;
        --task-file)
            export RALPH_TASK_FILE="$2"
            shift 2
            ;;
        --project-dir=*)
            export RALPH_PROJECT_DIR="${1#*=}"
            shift
            ;;
        --project-dir)
            export RALPH_PROJECT_DIR="$2"
            shift 2
            ;;
        --state-dir=*)
            export RALPH_STATE_DIR="${1#*=}"
            shift
            ;;
        --state-dir)
            export RALPH_STATE_DIR="$2"
            shift 2
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done
set -- "${POSITIONAL_ARGS[@]}"

source "${RALPH_LIB_DIR}/config.sh"

# Colors (redefined for local use)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m'

VERSION="1.0.0"

show_help() {
    echo -e "${BOLD}ralph${NC} - Autonomous task execution orchestrator for Claude"
    echo ""
    echo -e "${BOLD}USAGE${NC}"
    echo "    ralph [options] <command> [command-options]"
    echo ""
    echo -e "${BOLD}COMMANDS${NC}"
    echo -e "    ${CYAN}run${NC}                 Run a single iteration"
    echo -e "    ${CYAN}loop${NC} [n] [delay]    Run n iterations (default: 10, delay: 5s)"
    echo -e "    ${CYAN}status${NC}              Show current session status"
    echo -e "    ${CYAN}watch${NC} [mode]        Watch logs in real-time"
    echo "                        Modes: latest (default), session, all"
    echo -e "    ${CYAN}init${NC}                Initialize or reset session"
    echo -e "    ${CYAN}unlock${NC} [--force]    Remove lock file"
    echo -e "    ${CYAN}clean${NC} [n|--all]     Clean up old logs (keep n, default: 5)"
    echo -e "    ${CYAN}help${NC}                Show this help message"
    echo -e "    ${CYAN}version${NC}             Show version"
    echo ""
    echo -e "${BOLD}OPTIONS${NC}"
    echo "    --mode <mode>           Execution mode: direct (default) or sandbox"
    echo "    --permission-mode <m>   Claude permission: acceptEdits (default)"
    echo "    --task-file <file>      Task file name (default: tasks.json)"
    echo "    --project-dir <dir>     Project directory (default: current dir)"
    echo "    --state-dir <dir>       State directory (default: .ralph/)"
    echo ""
    echo -e "${BOLD}EXAMPLES${NC}"
    echo "    ralph run                       # Run single iteration"
    echo "    ralph --mode sandbox run        # Run in sandbox mode"
    echo "    ralph --task-file my.json run   # Use custom task file"
    echo "    ralph loop 5                    # Run 5 iterations"
    echo "    ralph loop 10 10                # Run 10 iterations, 10s delay"
    echo "    ralph status                    # Check progress"
    echo "    ralph watch                     # Tail current log"
    echo ""
    echo -e "${BOLD}ENVIRONMENT${NC}"
    echo "    Options can also be set via environment variables:"
    echo "    RALPH_MODE, RALPH_PERMISSION_MODE, RALPH_TASK_FILE,"
    echo "    RALPH_PROJECT_DIR, RALPH_STATE_DIR"
    echo "    (Command-line flags take precedence over environment variables)"
    echo ""
    echo -e "${BOLD}FILES${NC}"
    echo "    .ralph/session.json     Current session state"
    echo "    .ralph/current-task.md  Current task details"
    echo "    .ralph/logs/            Iteration log files"
    echo "    .ralph/ralph.lock       Lock file (prevents concurrent runs)"
    echo "    tasks.json              Task definitions"
}

show_version() {
    echo "ralph version ${VERSION}"
}

cmd_run() {
    exec "${RALPH_LIB_DIR}/ralph-run.sh" "$@"
}

cmd_loop() {
    exec "${RALPH_LIB_DIR}/ralph-loop.sh" "$@"
}

cmd_status() {
    exec "${RALPH_LIB_DIR}/ralph-status.sh" "$@"
}

cmd_watch() {
    exec "${RALPH_LIB_DIR}/ralph-watch.sh" "$@"
}

cmd_init() {
    exec "${RALPH_LIB_DIR}/ralph-init.sh" "$@"
}

cmd_unlock() {
    exec "${RALPH_LIB_DIR}/ralph-unlock.sh" "$@"
}

cmd_clean() {
    echo -e "${BLUE}=== Cleaning Ralph Logs ===${NC}"
    echo ""

    if [ ! -d "${LOGS_DIR}" ]; then
        echo "No logs directory found"
        exit 0
    fi

    LOG_COUNT=$(find "${LOGS_DIR}" -name "*.log" 2>/dev/null | wc -l | tr -d ' ')

    if [ "$LOG_COUNT" -eq 0 ]; then
        echo "No log files to clean"
        exit 0
    fi

    TOTAL_SIZE=$(du -sh "${LOGS_DIR}" 2>/dev/null | cut -f1)
    echo "Found ${LOG_COUNT} log files (${TOTAL_SIZE})"
    echo ""

    KEEP_RECENT="${1:-5}"

    if [ "$1" = "--all" ]; then
        echo -e "${YELLOW}Removing ALL log files...${NC}"
        rm -f "${LOGS_DIR}"/*.log
        echo -e "${GREEN}Done${NC}"
    else
        echo "Keeping ${KEEP_RECENT} most recent logs"
        echo ""

        FILES_TO_DELETE=$(ls -t "${LOGS_DIR}"/*.log 2>/dev/null | tail -n +$((KEEP_RECENT + 1)))

        if [ -z "$FILES_TO_DELETE" ]; then
            echo "Nothing to clean (${LOG_COUNT} <= ${KEEP_RECENT})"
            exit 0
        fi

        DELETE_COUNT=$(echo "$FILES_TO_DELETE" | wc -l | tr -d ' ')
        echo -e "${YELLOW}Removing ${DELETE_COUNT} old log files...${NC}"

        echo "$FILES_TO_DELETE" | xargs rm -f

        echo -e "${GREEN}Done${NC}"

        REMAINING=$(find "${LOGS_DIR}" -name "*.log" 2>/dev/null | wc -l | tr -d ' ')
        echo ""
        echo "Remaining: ${REMAINING} log files"
    fi
}

# Parse command
COMMAND="${1:-help}"
shift 2>/dev/null || true

case "$COMMAND" in
    run|r)
        cmd_run "$@"
        ;;
    loop|l)
        cmd_loop "$@"
        ;;
    status|s|st)
        cmd_status "$@"
        ;;
    watch|w)
        cmd_watch "$@"
        ;;
    init|i)
        cmd_init "$@"
        ;;
    unlock|u)
        cmd_unlock "$@"
        ;;
    clean|c)
        cmd_clean "$@"
        ;;
    help|h|--help|-h)
        show_help
        ;;
    version|v|--version|-v)
        show_version
        ;;
    *)
        echo -e "${RED}Unknown command: ${COMMAND}${NC}"
        echo ""
        echo "Run 'ralph help' for usage"
        exit 1
        ;;
esac
